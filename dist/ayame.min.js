!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Ayame={})}(this,(function(e){"use strict";function t(){const e=window.navigator.userAgent.toLocaleLowerCase();return-1!==e.indexOf("edge")?"edge":-1!==e.indexOf("chrome")&&-1===e.indexOf("edge")?"chrome":-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")?"safari":-1!==e.indexOf("opera")?"opera":-1!==e.indexOf("firefox")?"firefox":"unknown"}function i(e,t){let i="";i="VP8"===e?"video/VP8":"VP9"===e?"video/VP9":"H264"===e?"video/H264":`video/${e}`;const s=t.filter((e=>e.mimeType==i));if(s.length<1)throw new Error("invalid video codec type");return s}function s(e,t){if(e.startsWith("audio/")){const[i,s,n]=e.split(" ");console.log(i,s,n);const a=t.findIndex((e=>e.mimeType===i&&e.clockRate===parseInt(s,10)&&e.sdpFmtpLine===n)),o=t[a],c=t;return c.splice(a,1),c.unshift(o),c.splice(1),console.log("Preferred audio codec",o),console.log(JSON.stringify(c,null," ")),c}let i="";i="opus"===e?"audio/opus":"ISAC"===e?"audio/ISAC":"G722"===e?"audio/G722":"PCMU"===e?"audio/PCMU":"PCMA"===e?"audio/PCMA":"red"===e?"audio/red":`audio/${e}`;const s=t.filter((e=>e.mimeType==i));if(s.length<1)throw new Error("invalid audio codec type");return s}class n extends class{constructor(e,t,i,s=!1,n=!1){this.debug=s,this.roomId=t,this.signalingUrl=e,this.options=i,this._removeVideoCodec=!1,this.stream=null,this.remoteStream=null,this._pc=null,this._ws=null,this.authnMetadata=null,this.authzMetadata=null,this._dataChannels=[],this._isOffer=!1,this._isExistUser=!1,this.connectionState="new",this._pcConfig={iceServers:this.options.iceServers,iceTransportPolicy:n?"relay":"all"},this._callbacks={open:()=>{},connect:()=>{},disconnect:()=>{},addstream:()=>{},removestream:()=>{},bye:()=>{},datachannel:()=>{}}}on(e,t){e in this._callbacks&&(this._callbacks[e]=t)}async _disconnect(){await this._dataChannels.forEach((async e=>{await this._closeDataChannel(e)})),await this._closePeerConnection(),await this._closeWebSocketConnection(),this.authzMetadata=null,this._removeVideoCodec=!1,this._isOffer=!1,this._isExistUser=!1,this._dataChannels=[],this.connectionState="new"}async _signaling(){return new Promise(((e,t)=>{if(this._ws)return t("WS-ALREADY-EXISTS");this._ws=new WebSocket(this.signalingUrl),this._ws.onclose=async()=>(await this._disconnect(),this._callbacks.disconnect({reason:"WS-CLOSED"}),t("WS-CLOSED")),this._ws.onerror=async()=>(await this._disconnect(),t("WS-CLOSED-WITH-ERROR")),this._ws.onopen=()=>{const i={type:"register",roomId:this.roomId,clientId:this.options.clientId,authnMetadata:void 0,key:void 0};null!==this.authnMetadata&&(i.authnMetadata=this.authnMetadata),null!==this.options.signalingKey&&(i.key=this.options.signalingKey),this._sendWs(i),this._ws&&(this._ws.onmessage=async i=>{try{if("string"!=typeof i.data)return;const s=JSON.parse(i.data);if("ping"===s.type)this._sendWs({type:"pong"});else{if("bye"===s.type)return this._callbacks.bye(i),e();if("accept"===s.type)return this.authzMetadata=s.authzMetadata,Array.isArray(s.iceServers)&&s.iceServers.length>0&&(this._traceLog("iceServers=>",s.iceServers),this._pcConfig.iceServers=s.iceServers),this._traceLog("isExistUser=>",s.isExistUser),this._isExistUser=s.isExistUser,this._createPeerConnection(),!0===this._isExistUser&&await this._sendOffer(),e();if("reject"===s.type)return await this._disconnect(),this._callbacks.disconnect({reason:s.reason||"REJECTED"}),t("REJECTED");if("offer"===s.type)this._pc&&"have-local-offer"===this._pc.signalingState&&this._createPeerConnection(),this._setOffer(new RTCSessionDescription(s));else if("answer"===s.type)await this._setAnswer(new RTCSessionDescription(s));else if("candidate"===s.type&&s.ice){this._traceLog("Received ICE candidate ...",s.ice);const e=new RTCIceCandidate(s.ice);this._addIceCandidate(e)}}}catch(e){await this._disconnect(),this._callbacks.disconnect({reason:"SIGNALING-ERROR",error:e})}})}}))}_createPeerConnection(){this._traceLog("RTCConfiguration=>",this._pcConfig);const e=new RTCPeerConnection(this._pcConfig),n=this.stream&&this.stream.getAudioTracks()[0];if(n&&"recvonly"!==this.options.audio.direction){const t=e.addTrack(n,this.stream),i=this._getTransceiver(e,t);if(this._isAudioCodecSpecified()&&null!==i&&void 0!==i.setCodecPreferences){const e=RTCRtpSender.getCapabilities("audio");if(e&&this.options.audio.codec){let t=s(this.options.audio.codec,e.codecs);this._traceLog("audio codecs=",t),i.setCodecPreferences(t)}}}else if(this.options.audio.enabled){const t=e.addTransceiver("audio",{direction:"recvonly"});if(this._isAudioCodecSpecified()&&void 0!==t.setCodecPreferences){const e=RTCRtpReceiver.getCapabilities("audio");if(e&&this.options.audio.codec){let i=s(this.options.audio.codec,e.codecs);this._traceLog("audio codecs=",i),t.setCodecPreferences(i)}}}const a=this.stream&&this.stream.getVideoTracks()[0];if(a&&"recvonly"!==this.options.video.direction){const t=e.addTrack(a,this.stream),s=this._getTransceiver(e,t);if(this._isVideoCodecSpecified()&&null!==s)if(void 0!==s.setCodecPreferences){const e=RTCRtpSender.getCapabilities("video");if(e){let t=[];this.options.video.codec&&(t=i(this.options.video.codec,e.codecs)),this._traceLog("video codecs=",t),s.setCodecPreferences(t)}}else this._removeVideoCodec=!0}else if(this.options.video.enabled){const t=e.addTransceiver("video",{direction:"recvonly"});if(this._isVideoCodecSpecified())if(void 0!==t.setCodecPreferences){const e=RTCRtpSender.getCapabilities("video");if(e){let s=[];this.options.video.codec&&(s=i(this.options.video.codec,e.codecs)),this._traceLog("video codecs=",s),t.setCodecPreferences(s)}}else this._removeVideoCodec=!0}const o=[];e.ontrack=e=>{const i=e;if(this._traceLog("peer.ontrack()",e),"safari"===t()){o.push(e.track);const t=new MediaStream(o);this.remoteStream=t}else this.remoteStream=e.streams[0];i.stream=this.remoteStream,this._callbacks.addstream(i)},e.onicecandidate=e=>{this._traceLog("peer.onicecandidate()",e),e.candidate?this._sendIceCandidate(e.candidate):this._traceLog("empty ice event","")},e.oniceconnectionstatechange=async()=>{if(this._traceLog("ICE connection Status has changed to ",e.iceConnectionState),this.connectionState!==e.iceConnectionState)switch(this.connectionState=e.iceConnectionState,this.connectionState){case"connected":this._isOffer=!1,this._callbacks.connect();break;case"disconnected":case"failed":await this._disconnect(),this._callbacks.disconnect({reason:"ICE-CONNECTION-STATE-FAILED"})}},e.onsignalingstatechange=t=>{this._traceLog("signaling state changes:",e.signalingState)},e.ondatachannel=this._onDataChannel.bind(this),this._pc?this._pc=e:(this._pc=e,this._callbacks.open({authzMetadata:this.authzMetadata}))}async _createDataChannel(e,t){return new Promise(((i,s)=>{if(!this._pc)return s("PeerConnection Does Not Ready");if(this._isOffer)return s("PeerConnection Has Local Offer");let n=this._findDataChannel(e);return n?s("DataChannel Already Exists!"):this._isExistUser?(n=this._pc.createDataChannel(e,t),n.onclose=t=>{this._traceLog("datachannel onclosed=>",t),this._dataChannels=this._dataChannels.filter((t=>t.label!=e))},n.onerror=t=>{this._traceLog("datachannel onerror=>",t),this._dataChannels=this._dataChannels.filter((t=>t.label!=e))},n.onmessage=t=>{this._traceLog("datachannel onmessage=>",t.data),t.label=e},n.onopen=e=>{this._traceLog("datachannel onopen=>",e)},this._dataChannels.push(n),i(n)):i(null)}))}_onDataChannel(e){if(this._traceLog("on data channel",e),!this._pc)return;const t=e.channel,i=e.channel.label;e.channel&&(!i||i.length<1||(t.onopen=async e=>{this._traceLog("datachannel onopen=>",e)},t.onclose=async e=>{this._traceLog("datachannel onclosed=>",e)},t.onerror=async e=>{this._traceLog("datachannel onerror=>",e)},t.onmessage=e=>{this._traceLog("datachannel onmessage=>",e.data),e.label=i},this._findDataChannel(i)?this._dataChannels=this._dataChannels.map((e=>e.label==i?t:e)):this._dataChannels.push(e.channel),this._callbacks.datachannel(t)))}async _sendOffer(){if(!this._pc)return;"safari"===t()&&(this.options.video.enabled&&"sendrecv"===this.options.video.direction&&this._pc.addTransceiver("video",{direction:"recvonly"}),this.options.audio.enabled&&"sendrecv"===this.options.audio.direction&&this._pc.addTransceiver("audio",{direction:"recvonly"}));const e=await this._pc.createOffer({offerToReceiveAudio:this.options.audio.enabled&&"sendonly"!==this.options.audio.direction,offerToReceiveVideo:this.options.video.enabled&&"sendonly"!==this.options.video.direction});if(this._removeVideoCodec&&this.options.video.codec){["VP8","VP9","H264"].forEach((t=>{this.options.video.codec!==t&&(e.sdp=function(e,t){return function i(s){const n=new RegExp("(a=rtpmap:(\\d*) "+t+"/90000\\r\\n)"),a=s.match(n);if(null==a||a.length<=2)return e;const o=a[2];let c=s.replace(n,"");const r=new RegExp("(a=rtcp-fb:"+o+".*\r\n)","g");c=c.replace(r,"");const d=new RegExp("(a=fmtp:"+o+".*\r\n)","g");c=c.replace(d,"");const h=new RegExp("(a=fmtp:(\\d*) apt="+o+"\\r\\n)"),l=c.match(h);let _="";if(null!=l&&l.length>=3){_=l[2],c=c.replace(h,"");const e=new RegExp("(a=rtpmap:"+_+".*\r\n)","g");c=c.replace(e,"")}const p=/(m=video.*\r\n)/,f=c.match(p);if(null!=f){const e=f[0].substring(0,f[0].length-2).split(" ");let t=e[0];e.forEach(((e,i)=>{0!==i&&e!=o&&e!=_&&(t+=" "+e)})),t+="\r\n",c=c.replace(p,t)}return i(c)}(e)}(e.sdp,t))}))}this._traceLog("create offer sdp, sdp=",e.sdp),await this._pc.setLocalDescription(e),this._pc.localDescription&&this._sendSdp(this._pc.localDescription),this._isOffer=!0}_isAudioCodecSpecified(){return this.options.audio.enabled&&null!==this.options.audio.codec}_isVideoCodecSpecified(){return this.options.video.enabled&&null!==this.options.video.codec}async _createAnswer(){if(this._pc)try{const e=await this._pc.createAnswer();this._traceLog("create answer sdp, sdp=",e.sdp),await this._pc.setLocalDescription(e),this._pc.localDescription&&this._sendSdp(this._pc.localDescription)}catch(e){await this._disconnect(),this._callbacks.disconnect({reason:"CREATE-ANSWER-ERROR",error:e})}}async _setAnswer(e){this._pc&&(await this._pc.setRemoteDescription(e),this._traceLog("set answer sdp=",e.sdp))}async _setOffer(e){try{if(!this._pc)return;await this._pc.setRemoteDescription(e),this._traceLog("set offer sdp=",e.sdp),await this._createAnswer()}catch(e){await this._disconnect(),this._callbacks.disconnect({reason:"SET-OFFER-ERROR",error:e})}}async _addIceCandidate(e){try{this._pc&&await this._pc.addIceCandidate(e)}catch(t){this._traceLog("invalid ice candidate",e)}}_sendIceCandidate(e){const t={type:"candidate",ice:e};this._sendWs(t)}_sendSdp(e){this._sendWs(e)}_sendWs(e){this._ws&&this._ws.send(JSON.stringify(e))}_getTransceiver(e,t){let i=null;if(e.getTransceivers().forEach((e=>{e.sender!=t&&e.receiver!=t||(i=e)})),!i)throw new Error("invalid transceiver");return i}_findDataChannel(e){return this._dataChannels.find((t=>t.label==e))}async _closeDataChannel(e){return new Promise((t=>{if("closed"===e.readyState)return t();e.onclose=null;const i=setInterval((()=>{if("closed"===e.readyState)return clearInterval(i),t()}),400);e&&e.close()}))}async _closePeerConnection(){return new Promise((e=>{if("safari"===t()&&this._pc)return this._pc.oniceconnectionstatechange=()=>{},this._pc.close(),this._pc=null,e();if(!this._pc)return e();if(this._pc&&"closed"==this._pc.signalingState)return this._pc=null,e();this._pc.oniceconnectionstatechange=()=>{};const i=setInterval((()=>this._pc?this._pc&&"closed"==this._pc.signalingState?(this._pc=null,clearInterval(i),e()):void 0:(clearInterval(i),e())),400);this._pc.close()}))}async _closeWebSocketConnection(){return new Promise((e=>{if(!this._ws)return e();if(this._ws&&3===this._ws.readyState)return this._ws=null,e();this._ws.onclose=()=>{};const t=setInterval((()=>this._ws?3===this._ws.readyState?(this._ws=null,clearInterval(t),e()):void 0:(clearInterval(t),e())),400);this._ws&&this._ws.close()}))}_traceLog(e,i){this.debug&&function(e,i){let s="";window.performance&&(s="[Ayame "+(window.performance.now()/1e3).toFixed(3)+"]"),"edge"===t()?console.log(s+" "+e+"\n",i):console.info(s+" "+e+"\n",i)}(e,i)}}{constructor(e,t,i,s=!1,n=!1){super(e,t,i,s,n)}async connect(e,t=null){if(this._ws||this._pc)throw this._traceLog("connection already exists"),new Error("Connection Already Exists!");this.stream=e,t&&(this.authnMetadata=t.authnMetadata),await this._signaling()}async createDataChannel(e,t){return await this._createDataChannel(e,t)}async removeDataChannel(e){this._traceLog("datachannel remove=>",e);const t=this._findDataChannel(e);if(!t||"open"!==t.readyState)throw new Error("data channel is not exist or open");await this._closeDataChannel(t)}async disconnect(){return new Promise((e=>(this._ws&&this._ws.close(),e())))}}const a={audio:{direction:"sendrecv",enabled:!0},video:{direction:"sendrecv",enabled:!0},iceServers:[],clientId:function(e){const t=[],i="0123456789";for(;e--;)t.push(i.charAt(Math.floor(Math.random()*i.length)));return t.join("")}(17)};e.connection=function(e,t,i=a,s=!1,o=!1){return new n(e,t,i,s,o)},e.defaultOptions=a,e.version=function(){return process.version},Object.defineProperty(e,"__esModule",{value:!0})}));//# sourceMappingURL=ayame.min.js.map
